<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Canteen Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #03045e;
      --secondary: #46a0fa;
      --price: #d22c27;
      --buttons: #46a0fa;
      --accent: #FFD166;
      --background: #F7FFF7;
      --text: #292F36;
      --card-bg: #FFFFFF;
      --border-radius: 12px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      background: var(--background);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    header { 
      background-color: var(--primary); 
      color: white; 
      height: 90px;
      padding: 10px 20px; 
      position: sticky; 
      top: 0; 
      z-index: 100; 
      box-shadow: var(--shadow); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      min-height: 70px;
    }

    .logo {
      position: absolute;
      left: 20px;
      max-height: 80px;
      height: auto;
      width: auto;
    }

    main {
      padding: 16px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      flex: 1;
    }

    .row { display: flex; gap: 10px; margin: 16px 0 18px; flex-wrap: wrap; }
    .input {
      flex: 1 1 auto; padding: 12px 14px; border: 1px solid #e4e6eb; border-radius: 10px;
      background: #fff; outline: none; transition: var(--transition); font-size: 0.95rem;
    }
    .input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(210,44,39,0.12); }

    .btn {
      padding: 10px 16px; border: none; border-radius: 10px; font-weight: 600;
      cursor: pointer; transition: var(--transition); box-shadow: var(--shadow);
      white-space: nowrap; flex-shrink: 0;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #b3231f; }
    .btn-ghost { background: #fff3f3; color: var(--primary); border: 1px solid #ffd0d0; }
    .btn-ghost:hover { background: #ffe6e6; }
    .btn-danger { background: #FF6400; color: #fff; }
    .btn-danger:hover { background: #9f4102; }

    h2.section-title { font-size: 1.25rem; font-weight: 700; margin: 12px 0 16px; color: #3a3f45; text-align: center; }

    .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .order-card {
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow);
      padding: 16px; display: flex; flex-direction: column; gap: 12px; transition: transform 0.2s ease;
    }
    .order-card:hover { transform: translateY(-2px); }

    .order-head { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .order-id { font-weight: 700; color: var(--primary); font-size: 1rem; }
    .status {
      font-size: 0.8rem; padding: 5px 10px; border-radius: 999px; font-weight: 700;
      background: #fff3f3; color: var(--primary); border: 1px solid #ffd0d0; white-space: nowrap;
    }
    .status.accepted { background: #fff8e1; color: #8a6d00; border-color: #ffeaa7; }
    .status.completed { background: #e1f0ff; color: #005b9f; border: 1px solid #9ed1ff; }

    .order-body p { margin: 4px 0; font-size: 0.95rem; line-height: 1.35; }
    .items { font-size: 0.92rem; color: #3c3c3c; }
    .total { font-weight: 800; color: var(--price); display: flex; gap: 8px; flex-wrap: wrap; }

    .order-actions { display: flex; flex-wrap: wrap; gap: 8px; }
    .order-actions .btn { flex: 1 1 auto; min-width: 120px; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); color: white; padding: 10px 18px;
      border-radius: 20px; font-size: 0.9rem; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease; z-index: 1000;
    }
    .toast.show { opacity: 1; }

    @media (max-width: 720px) {
      .row { flex-direction: column; }
      .btn, .order-actions .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <img src="Pes_logo.png" alt="Logo" class="logo"> <!-- Replace with your logo -->
    <h1>P.E.S. Canteen Panel</h1>
  </header>

  <main>
    <div class="row">
      <input class="input" type="text" id="searchCode" placeholder="Enter Order Code (e.g., ORD-1234)" />
      <button class="btn btn-primary" onclick="findOrder()">Find</button>
    </div>

    <h2 class="section-title">Active Orders</h2>
    <div id="orders" class="orders-grid"></div>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, getDocs, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQFOv3uq9uviBQOjJAdgSni1uyikGPgbo",
      authDomain: "pes-canteen.firebaseapp.com",
      projectId: "pes-canteen",
      storageBucket: "pes-canteen.firebasestorage.app",
      messagingSenderId: "398702472399",
      appId: "1:398702472399:web:626587a3b358bd55075bba",
      measurementId: "G-LL28HG6PDB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ordersDiv = document.getElementById("orders");
    const toast = document.getElementById("toast");

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1600);
    }

    function tsToMs(ts) { return ts?.toMillis ? ts.toMillis() : (ts || 0); }
    function parseDateTime(dateStr, timeStr) {
      const ms = Date.parse((dateStr||"") + " " + (timeStr||""));
      return isNaN(ms) ? 0 : ms;
    }
    function sortKey(order) {
      return tsToMs(order.createdAt) || tsToMs(order.timestamp) || parseDateTime(order.date, order.time) || 0;
    }

    // Only fetch orders that are NOT completed
    const activeOrdersQuery = query(collection(db, "orders"));
    onSnapshot(activeOrdersQuery, (snapshot) => {
      const list = [];
      snapshot.forEach((docSnap) => {
        const order = docSnap.data();
        order.id = docSnap.id;
        if (order.status !== "completed") {
          list.push(order);
        }
      });
      list.sort((a,b) => sortKey(b) - sortKey(a));
      renderOrders(list);
    });

    function renderOrders(orders) {
      ordersDiv.innerHTML = "";
      if (!orders.length) {
        ordersDiv.innerHTML = `<div class="order-card"><p>No active orders right now.</p></div>`;
        return;
      }

      orders.forEach(order => {
        const items = Array.isArray(order.items) ? order.items : [];
        const total = order.totalAmount || items.reduce((sum, it) => sum + ((it.price || 0) * (it.quantity || 1)), 0);
        const itemsText = items.map(it => `${it.name} x ${it.quantity || 1}`).join(", ");

        let statusClass = "status";
        let statusLabel = order.status || "-";

        if (order.status === "accepted") {
          statusClass = "status accepted";
          statusLabel = "Accepted";
        } else if (order.status === "completed") {
          statusClass = "status completed";
          statusLabel = "Completed";
        }

        const card = document.createElement("div");
        card.className = "order-card";
        card.id = `order-${order.id}`;
        card.innerHTML = `
          <div class="order-head">
            <div>
              <div class="order-id">Table ${order.table || "-"}</div>
              <div style="font-size:.95rem; font-weight:500; color:#3c3c3c;">Code: ${order.orderCode || "-"}</div>
            </div>
            <span class="${statusClass}">${statusLabel}</span>
          </div>

          <div class="order-body">
            <p class="items"><strong>Items: ${itemsText || "-"}</strong></p>
            <p class="total"><strong>Total: â‚¹${total}</strong></p>
            <p style="font-weight:500; font-size:.95rem;color:#3c3c3c;">
              <strong>Date:</strong> ${order.date || "N/A"} &nbsp; <strong>Time:</strong> ${order.time || "N/A"}
            </p>
          </div>

          <div class="order-actions">
            ${order.status === "pending" ? `<button class="btn btn-primary" onclick="updateStatus('${order.id}','accepted')">Accept</button>` : ""}
            ${order.status === "accepted" ? `<button class="btn btn-ghost" onclick="updateStatus('${order.id}','completed')">Complete</button>` : ""}
            <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">Delete</button>
          </div>
        `;
        ordersDiv.appendChild(card);
      });
    }

    window.updateStatus = async function(id, status) {
      await updateDoc(doc(db, "orders", id), { status, timestamp: serverTimestamp() });
      showToast(`Order marked as ${status}`);
    };

    window.findOrder = async function() {
      const code = document.getElementById("searchCode").value.trim();
      if (!code) { alert("Please enter an order code"); return; }
      const q = query(collection(db, "orders"), where("orderCode", "==", code));
      const snap = await getDocs(q);
      const orders = [];
      snap.forEach(d => { const o = d.data(); o.id = d.id; orders.push(o); });
      orders.sort((a,b)=>sortKey(b)-sortKey(a));
      renderOrders(orders);
    };

    window.deleteOrder = async function(orderId) {
      if (confirm("Are you sure you want to delete this order?")) {
        await deleteDoc(doc(db, "orders", orderId));
        showToast("Order deleted successfully");
      }
    };
  </script>
</body>
</html>
