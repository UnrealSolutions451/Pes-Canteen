<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Canteen Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --primary:#03045e; --price:#d22c27; --bg:#F7FFF7; --text:#292F36;
      --shadow:0 4px 6px rgba(0,0,0,.1);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui}
    body{background:var(--bg);min-height:100vh;display:flex;flex-direction:column}

    header{
      background:var(--primary);color:#fff;height:90px;display:flex;align-items:center;
      justify-content:center;position:sticky;top:0;z-index:10;box-shadow:var(--shadow)
    }
    .logo{position:absolute;left:20px;max-height:70px}
    .logout-container{position:absolute;right:20px;top:25px}
    #logoutBtn{background:#d22c27;color:#fff;border:none;padding:8px 16px;border-radius:20px}

    main{padding:16px;max-width:1300px;margin:auto;width:100%}

    .row{display:flex;gap:10px;margin:10px 0 18px;flex-wrap:wrap}
    .input{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px}
    .btn{padding:10px 16px;border:none;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-scan{background:#1f7ae0;color:#fff}
    .btn-danger{background:#ff6a00;color:#fff}
    .btn-pay{background:#1a8f3d;color:#fff}

    /* ----- COLUMNS + SEPARATOR ----- */
    .columns-wrap{
      display:grid;
      grid-template-columns:1fr 1px 1fr;
      gap:16px;
      align-items:start;
    }
    .divider{
      background:#d0d7e2;
      width:1px;
      height:100%;
    }
    @media(max-width:900px){
      .columns-wrap{grid-template-columns:1fr}
      .divider{display:none}
    }

    h2{text-align:center;margin-bottom:10px}

    .orders-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}

    .order-card{
      background:#fff;border-radius:12px;padding:14px;box-shadow:var(--shadow);
      transition:.2s
    }
    .order-card.highlight{
      outline:4px solid #46a0fa;
      box-shadow:0 0 0 6px rgba(70,160,250,.25);
    }

    .order-head{display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px}
    .status{padding:5px 10px;border-radius:20px;font-size:.8rem;font-weight:700}
    .pending{background:#ffe3e3}
    .accepted{background:#fff8c5}
    .ready{background:#d3ffd3}

    .order-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .order-actions .btn{flex:1}

    /* MODALS */
    .payment-modal,.scanner-modal{
      position:fixed;inset:0;background:rgba(0,0,0,.7);
      display:none;align-items:center;justify-content:center;z-index:1000
    }
    .payment-box,.scanner-box{
      background:#fff;padding:20px;border-radius:14px;width:95%;max-width:400px;text-align:center
    }
    .payment-box img{width:230px;height:230px;margin-top:10px}
    .closeBtn{margin-top:12px;padding:8px 14px;border:none;border-radius:8px;background:#d22c27;color:#fff}
    #qr-reader{width:100%}
  </style>
</head>

<body>
<script type="module" src="auth-guard.js"></script>

<header>
  <img src="Pes_logo.png" class="logo">
  <h1>P.E.S. Canteen Panel</h1>
  <div class="logout-container"><button id="logoutBtn">Logout</button></div>
</header>

<main>
  <div class="row">
    <input id="searchCode" class="input" placeholder="Search / Scan Order Code">
    <button class="btn btn-primary" id="findBtn">Find</button>
    <button class="btn btn-scan" onclick="openScanner()">Scan</button>
  </div>

  <div class="columns-wrap">
    <div>
      <h2>Pending Orders</h2>
      <div id="pendingOrders" class="orders-grid"></div>
    </div>

    <div class="divider"></div>

    <div>
      <h2>Accepted / Ready Orders</h2>
      <div id="acceptedOrders" class="orders-grid"></div>
    </div>
  </div>
</main>

<!-- PAYMENT -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-box">
    <h3>Scan & Pay</h3>
    <p id="amountText"></p>
    <img id="qrImage">
    <button class="closeBtn" onclick="closePayment()">Close</button>
  </div>
</div>

<!-- SCANNER -->
<div class="scanner-modal" id="scannerModal">
  <div class="scanner-box">
    <h3>Scan Order QR</h3>
    <div id="qr-reader"></div>
    <button class="closeBtn" onclick="closeScanner()">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import {
  getFirestore, collection, query, onSnapshot,
  doc, updateDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDQFOv3uq9uviBQOjJAdgSni1uyikGPgbo",
  authDomain:"pes-canteen.firebaseapp.com",
  projectId:"pes-canteen",
  storageBucket:"pes-canteen.firebasestorage.app",
  messagingSenderId:"398702472399",
  appId:"1:398702472399:web:626587a3b358bd55075bba"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

logoutBtn.onclick=async()=>{await signOut(auth);location.href="login.html"}

const pendingDiv=document.getElementById("pendingOrders");
const acceptedDiv=document.getElementById("acceptedOrders");
let highlighted=null;

/* LIVE ORDERS */
onSnapshot(query(collection(db,"orders")),snap=>{
  const pending=[],accepted=[];
  snap.forEach(d=>{
    const o=d.data();o.id=d.id;
    if(o.status==="pending") pending.push(o);
    else if(o.status==="accepted"||o.status==="ready") accepted.push(o);
  });
  render(pending,pendingDiv,true);
  render(accepted,acceptedDiv,false);

  // keep highlight if order still exists
  if(highlighted){
    const id=highlighted.id;
    const newEl=document.getElementById(id);
    if(newEl){
      highlighted.classList.remove("highlight");
      highlighted=newEl;
      highlighted.classList.add("highlight");
    }
  }
});

/* RENDER */
function render(list,container,showPay){
  container.innerHTML="";
  list.forEach(o=>{
    const items=o.items||[]; let total=0;
    const txt=items.map(i=>{const q=i.quantity||1,p=i.price||0;total+=q*p;return`${i.name} x ${q}`});

    const div=document.createElement("div");
    div.className="order-card";
    div.id="order-"+o.orderCode;
    div.innerHTML=`
      <div class="order-head">
        <strong>${o.orderCode}</strong>
        <span class="status ${o.status}">${o.status}</span>
      </div>
      <p><b>Items:</b> ${txt.join(", ")}</p>
      <p><b>Total:</b> ₹${total}</p>
      <div class="order-actions">
        ${o.status==="pending"?`<button class="btn btn-primary">Accept</button>`:""}
        ${o.status==="accepted"?`<button class="btn btn-primary">Complete</button>`:""}
        ${o.status==="ready"?`<button class="btn btn-primary">Received</button>`:""}
        ${showPay?`<button class="btn btn-pay">Payment</button>`:""}
        <button class="btn btn-danger">Delete</button>
      </div>`;

    const btns=div.querySelectorAll("button");
    let i=0;

    if(o.status==="pending"){btns[i++].onclick=()=>setStat(o.id,"accepted")}
    if(o.status==="accepted"){btns[i++].onclick=()=>setStat(o.id,"ready")}
    if(o.status==="ready"){btns[i++].onclick=()=>setStat(o.id,"completed")}
    if(showPay){btns[i++].onclick=()=>openPayment(total,o.orderCode)}
    btns[i].onclick=()=>del(o.id);

    container.appendChild(div);
  });
}

/* ACTIONS */
const setStat=(id,s)=>updateDoc(doc(db,"orders",id),{status:s,timestamp:serverTimestamp()});
const del=id=>confirm("Delete?")&&deleteDoc(doc(db,"orders",id));

/* SEARCH + HIGHLIGHT */
function highlightOrder(code){
  const el=document.getElementById("order-"+code);
  if(el){
    if(highlighted)highlighted.classList.remove("highlight");
    highlighted=el;
    el.classList.add("highlight");
    el.scrollIntoView({behavior:"smooth",block:"center"});
  }
}

findBtn.onclick=()=>{ const code=searchCode.value.trim(); if(code) highlightOrder(code); };

document.body.addEventListener("click",e=>{
  if(highlighted&&!e.target.closest(".order-card")){
    highlighted.classList.remove("highlight"); highlighted=null;
  }
});

/* PAYMENT */
window.openPayment=(amt,id)=>{
  const upi="Q099759199@ybl";
  const link=`upi://pay?pa=${upi}&pn=Canteen&am=${amt}&cu=INR&tn=${id}`;
  qrImage.src=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(link)}`;
  amountText.innerText="Amount: ₹"+amt;
  paymentModal.style.display="flex";
};
window.closePayment=()=>paymentModal.style.display="none";

/* SCANNER */
let scanner;
window.openScanner=()=>{
  scannerModal.style.display="flex";
  scanner=new Html5QrcodeScanner("qr-reader",{fps:10,qrbox:250,facingMode:{exact:"environment"}},false);
  scanner.render(text=>{
    searchCode.value=text;
    closeScanner();
    highlightOrder(text);   // ✅ highlight from QR
  },()=>{});
};
window.closeScanner=()=>{try{scanner.clear()}catch{} scannerModal.style.display="none"};
</script>
</body>
</html>
