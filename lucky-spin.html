<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lucky Spin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background:#0ea5e9;
      margin:0;
      color:#0f172a;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
    }
    .wrap {
      max-width:520px;
      width:100%;
      margin: 16px;
      background:#fff;
      border-radius:16px;
      padding:22px;
      box-shadow:0 12px 36px rgba(0,0,0,0.18);
    }
    h1 { margin:0 0 6px; text-align:center; }
    .sub { text-align:center; color:#475569; margin-bottom:18px; font-size:14px; }
    .welcome { text-align:center; font-weight:600; margin:10px 0; }

    .wheel-wrap {
      display:flex;
      justify-content:center;
      align-items:center;
      margin: 40px auto 20px; /* more space above wheel */
      position: relative;
    }
    canvas {
      background:#fff;
      border-radius:50%;
      box-shadow:0 0 10px rgba(0,0,0,0.15);
    }
.pointer { position: absolute; top: -28px; /* move it slightly above the wheel */ left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 28px solid #ef4444; /* now pointing DOWN at the wheel */ }

    button {
      width:100%; padding:12px;
      border:none; border-radius:10px;
      background:#2563eb; color:#fff; font-weight:700;
      cursor:pointer; margin-top:12px; font-size:16px;
    }
    .code {
      margin-top:14px; padding:10px;
      background:#f1f5f9; border-radius:8px;
      font-family:monospace; text-align:center;
    }
    .note { font-size:13px; color:#475569; margin-top:8px; text-align:center; }
    .err {
      color:#b91c1c; background:#fee2e2;
      border:1px solid #fecaca; padding:8px 10px;
      border-radius:8px; margin-top:10px; font-size:13px;
    }
    .ok {
      color:#065f46; background:#d1fae5;
      border:1px solid #a7f3d0; padding:8px 10px;
      border-radius:8px; margin-top:10px; font-size:13px;
    }
    .links { margin-top:20px; text-align:center; }
    .links a {
      display:inline-block; margin:5px; padding:10px 16px;
      background:#0ea5e9; color:#fff; border-radius:8px;
      text-decoration:none; font-weight:600;
    }

    @media (max-width:480px) {
      canvas { width:260px !important; height:260px !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸŽ‰ Lucky Spin</h1>
    <div class="welcome" id="welcomeMsg"></div>
    <div class="sub">Win a discount coupon up to 100% â€” show it to the waiter to redeem (one-time).</div>

    <div class="wheel-wrap">
      <canvas id="wheelCanvas" width="320" height="320"></canvas>
      <div class="pointer"></div>
    </div>

    <button id="spinBtn">Spin Now</button>
    <div id="result"></div>
    <div class="note">If this is a follow-up order (different order code), you can spin again.</div>

    <div class="links">
      <a id="backToMenu">â¬… Back to Menu</a>
      <a href="my-coupons.html">ðŸŽŸ My Coupons</a>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Winwheel.js + GSAP -->
  <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel/Winwheel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <script>
  (function(){
    const prizes = [5,10,15,20,25,50,100];
    const colors = ["#fde047","#22d3ee","#a7f3d0","#fca5a5","#93c5fd","#ddd6fe","#fbbf24"];
    const spinBtn = document.getElementById('spinBtn');
    const resultEl = document.getElementById('result');
    const welcomeMsg = document.getElementById('welcomeMsg');

    // ðŸŽµ Sounds
    const tickSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
    const winSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
    const slowSound = new Audio("https://actions.google.com/sounds/v1/cartoon/metal_twang.ogg");

    const params = new URLSearchParams(window.location.search);
    const orderCode = (params.get('order') || params.get('orderCode') || '').trim();

    // Create the wheel
    const wheel = new Winwheel({
      'canvasId'    : 'wheelCanvas',
      'numSegments' : prizes.length,
      'outerRadius' : 140,
      'textFontSize': 16,
      'segments'    : prizes.map((p,i)=>({
        'fillStyle': colors[i % colors.length],
        'text': p + '%'
      })),
      'animation' : {
        'type'     : 'spinToStop',
        'duration' : 6,
        'spins'    : 8,
        'callbackSound': playTick,
        'callbackFinished' : awardPrize
      }
    });
    wheel.draw();

    // Firebase
    const auth = firebase.auth();
    const db = firebase.firestore();

    function preloadExistingCoupon(uid){
      if (!orderCode) return;
      db.collection('coupons')
        .where('userId','==', uid).where('orderCode','==', orderCode).limit(1)
        .get().then(snap=>{
          if (!snap.empty){
            const d=snap.docs[0].data();
            showCoupon(d.code,d.discountPercent);
            disableSpin("You already claimed a coupon for this order.");
          }
        });
    }

    function showCoupon(code,pct){
      resultEl.innerHTML=`<div class="ok">Congrats! You won <b>${pct}%</b> off.</div><div class="code">${code}</div>`;
      winSound.play();
    }
    function disableSpin(msg){ spinBtn.disabled=true; if(msg) resultEl.innerHTML+=`<div class="note">${msg}</div>`; }
    function genCode(len=6){ const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let out="SPN-"; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)]; return out; }

    function awardPrize(segment){
      const pct = parseInt(segment.text);
      const user = auth.currentUser;
      if(!user) return;
      slowSound.play();

      db.collection('coupons').where('userId','==', user.uid).where('orderCode','==', orderCode).limit(1).get().then(snap=>{
        if(!snap.empty){ const d=snap.docs[0].data(); showCoupon(d.code,d.discountPercent); return; }
        const code=genCode(6);
        db.collection('coupons').doc(code).set({
          code,userId:user.uid,orderCode,discountPercent:pct,used:false,
          createdAt:firebase.firestore.FieldValue.serverTimestamp()
        }).then(()=>{ showCoupon(code,pct); });
      });
    }

    function playTick(){
      tickSound.pause();
      tickSound.currentTime=0;
      tickSound.play();
    }

    spinBtn.addEventListener('click',()=>{
      const user = auth.currentUser;
      if(!user){ resultEl.innerHTML=`<div class="err">Please login again.</div>`; return; }
      if(!orderCode){ resultEl.innerHTML=`<div class="err">Order code missing.</div>`; return; }
      resultEl.innerHTML='';
      wheel.stopAnimation(false); wheel.rotationAngle=0; wheel.draw();
      wheel.startAnimation();
    });

    auth.onAuthStateChanged(user=>{
      if(!user){ window.location.href=`login.html${window.location.search}`; return; }
      welcomeMsg.textContent = "Welcome, " + (user.displayName || user.email);
      preloadExistingCoupon(user.uid);
    });

    const table=params.get('table');
    document.getElementById('backToMenu').href=table?`index.html?table=${table}`:'index.html';
  })();
  </script>
</body>
</html>
