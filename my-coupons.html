<!DOCTYPE html>
<html>
<head>
  <title>My Coupons</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .coupon {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    .used {
      color: red;
      font-weight: bold;
    }
    .unused {
      color: green;
      font-weight: bold;
    }
    .back-btn {
      margin-top: 20px;
      display: inline-block;
      padding: 10px 18px;
      background: #007bff;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }
    .no-coupons {
      color: #555;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>My Coupons</h1>
  <div id="couponList">Loading...</div>
  <a class="back-btn" id="backToMenu">â¬… Back to Menu</a>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
  (function(){
    const auth = firebase.auth();
    const couponList = document.getElementById("couponList");

    auth.onAuthStateChanged(async function(user) {
      if (!user) {
        alert("Please log in to see your coupons.");
        window.location.href = "login.html";
        return;
      }

      try {
        // Fetch all coupons for this user
        const snapshot = await firebase.firestore()
          .collection("coupons")
          .where("userId", "==", user.uid)
          .get();

        if (snapshot.empty) {
          couponList.innerHTML = '<p class="no-coupons">No coupons found.</p>';
          return;
        }

        // Map documents into an array with timestamp
        const coupons = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            code: data.code || doc.id,
            discountPercent: data.discountPercent || '-',
            used: data.used || false,
            orderCode: data.orderCode || '-',
            createdAt: data.createdAt ? data.createdAt.toDate() : new Date(0)
          };
        });

        // Sort by createdAt descending (newest first)
        coupons.sort((a, b) => b.createdAt - a.createdAt);

        couponList.innerHTML = "";
        coupons.forEach(coupon => {
          couponList.innerHTML += `
            <div class="coupon">
              <p><strong>Code:</strong> ${coupon.code}</p>
              <p><strong>Discount:</strong> ${coupon.discountPercent}%</p>
              <p>Status: <span class="${coupon.used ? "used" : "unused"}">
                ${coupon.used ? "Used" : "Unused"}
              </span></p>
              <p><small>Order: ${coupon.orderCode}</small></p>
            </div>
          `;
        });

      } catch (err) {
        console.error("Error loading coupons:", err);
        couponList.innerHTML = "<p class='no-coupons'>Error loading coupons.</p>";
      }
    });

    // Fix Back to Menu button
    const params = new URLSearchParams(window.location.search);
    const tableId = params.get("table");
    const backBtn = document.getElementById("backToMenu");
    backBtn.href = tableId ? `index.html?table=${encodeURIComponent(tableId)}` : "index.html";
  })();
</script>

</body>
</html>
