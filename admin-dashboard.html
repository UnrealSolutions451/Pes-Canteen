<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary: #03045e;
      --secondary: #46a0fa;
      --price: #d22c27;
      --buttons: #46a0fa;
      --accent: #FFD166;
      --background: #F7FFF7;
      --text: #2b2c2d;
      --card-bg: #FFFFFF;
      --border-radius: 12px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

    body {
      background: var(--background);
      color: var(--text);
      font-weight: 500;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: center;
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      text-align: center;
      font-size: 2.2rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    main {
      padding: 16px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      flex: 1;
    }

    /* Stats Bar */
    .stats {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .stat-box {
      flex: 1 1 200px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      font-weight: 700;
      color: var(--primary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 1rem;
      min-width: 180px;
    }
    .stat-box:hover { background: #fff5f5; }
    .stat-box.active { background: #28a745; color: white; }

    /* Filter */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    .filter-bar label { font-weight: 600; font-size: 0.95rem; margin-right: 6px; }
    .filter-bar select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      font-size: 0.9rem;
      flex: 0 1 180px;
      outline: none;
      transition: var(--transition);
    }
    .filter-bar select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(210,44,39,0.12); }

    #orderCount {
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--text);
      text-align: center;
    }

    /* Orders */
    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .order {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s ease;
    }
    .order:hover { transform: translateY(-3px); }
    .order strong { color: var(--primary); }
    s { color:#8c8c8c; }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    #toast.show { opacity: 1; }

    .logout-container {
      position: fixed;
      top: 10px;
      right: 10px;
    }
    #logoutBtn {
      background: #d22c27;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s;
    }
    #logoutBtn:hover { background: #a71d2a; }

    .admin-nav {
    background: var(--primary, #03045e);
    color: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .nav-container {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
  }
  .nav-logo {
    font-weight: 700;
    font-size: 1.1rem;
  }
  .nav-links {
    list-style: none;
    display: flex;
    gap: 18px;
  }
  .nav-links a {
    color: white;
    text-decoration: none;
    font-weight: 500;
    padding: 6px 10px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  .nav-links a:hover {
    background: rgba(255, 255, 255, 0.15);
  }
  .nav-links a.active {
    /* background: var(--accent, #FFD166); */
    color: #FFD166;
    font-weight: 700;
  }
  /* Mobile */
  .nav-toggle {
    display: none;
    font-size: 1.4rem;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
  }
  @media (max-width: 768px) {
    .nav-links {
      position: absolute;
      top: 56px;
      right: 0;
      background: var(--primary, #03045e);
      flex-direction: column;
      width: 200px;
      padding: 10px;
      display: none;
    }
    .nav-links.show {
      display: flex;
    }
    .nav-toggle {
      display: block;
    }
  }
  </style>
</head>
<body>
  <script type="module" src="auth-guard.js"></script>
  <header>Admin Dashboard 
    <div class="logout-container">
      <button id="logoutBtn">Logout</button>
    </div>
  </header>
  <nav class="admin-nav">
  <div class="nav-container">
    <div class="nav-logo">P.E.S. Canteen — Admin</div>

    <button class="nav-toggle" id="navToggle">☰</button>

    <ul class="nav-links" id="navLinks">
      <li><a href="admin-dashboard.html">Dashboard</a></li>
      <li><a href="analytics.html">Analytics</a></li>
      <li><a href="expense.html">Expenses</a></li>
      <li><a href="staff-managment.html">Staff</a></li>
    </ul>
  </div>
</nav>

  <main>
    <!-- Sales Stats -->
    <div class="stats">
      <div class="stat-box" id="todaySales">Today's Sales: ₹0</div>
      <div class="stat-box" id="monthSales">This Month's Sales: ₹0</div>
      <div class="stat-box" id="totalSales">Total Sales: ₹0</div>
    </div>

    <!-- Filter -->
    <div class="filter-bar">
      <label for="filter">Filter Orders:</label>
      <select id="filter">
        <option value="all">All</option>
        <option value="today">Today</option>
        <option value="month">This Month</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
      </select>
    </div>

    <!-- Order Count -->
    <div id="orderCount">Showing 0 orders</div>

    <!-- Orders -->
    <div id="orders" class="orders-grid"></div>
  </main>

  <div id="toast"></div>

  <script>
  // Toggle mobile nav
  document.getElementById("navToggle").onclick = () => {
    document.getElementById("navLinks").classList.toggle("show");
  };

  // Highlight current page
  const links = document.querySelectorAll(".nav-links a");
  links.forEach(link => {
    if (link.href === window.location.href) {
      link.classList.add("active");
    }
  });
</script>

  <!-- Firebase (v9) -->
  <script type="module">
    import { db, auth } from "./firebase-config.js";
    import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const ordersDiv = document.getElementById("orders");
    const filterSelect = document.getElementById("filter");
    const todaySalesEl = document.getElementById("todaySales");
    const monthSalesEl = document.getElementById("monthSales");
    const totalSalesEl = document.getElementById("totalSales");
    const orderCountEl = document.getElementById("orderCount");

    let unsubscribeOrders = null;

    function normalizeDate(dateStr) {
      if (!dateStr) return "";
      return new Date(dateStr).toISOString().split("T")[0];
    }

    function highlightStatBox(box) {
      document.querySelectorAll(".stat-box").forEach(el => el.classList.remove("active"));
      if (box) box.classList.add("active");
    }

    function loadOrders() {
      const filterValue = filterSelect.value;
      const todayDate = new Date().toISOString().split("T")[0];
      const currentMonth = todayDate.slice(0, 7);

      if (unsubscribeOrders) unsubscribeOrders();

      const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
      unsubscribeOrders = onSnapshot(q, snapshot => {
        let allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let filteredOrders = [];
        let todaySales = 0;
        let monthSales = 0;
        let totalSales = 0;

        allOrders.forEach(order => {
          const orderDate = normalizeDate(order.date);
          const originalTotal = order.items.reduce((sum, i) => sum + ((i.price||0)*(i.quantity||1)), 0);
          const total = order.totalAmount || originalTotal;

          if(order.status === "completed") {
            totalSales += total;
            if(orderDate.startsWith(currentMonth)) monthSales += total;
            if(orderDate === todayDate) todaySales += total;
          }
        });

        filteredOrders = allOrders.filter(order => {
          const orderDate = normalizeDate(order.date);
          if (filterValue === "today" && orderDate !== todayDate) return false;
          if (filterValue === "month" && !orderDate.startsWith(currentMonth)) return false;
          if (filterValue === "completed" && order.status !== "completed") return false;
          if (filterValue === "pending" && !["pending", "accepted"].includes(order.status)) return false;
          return true;
        });

        ordersDiv.innerHTML = filteredOrders.length
          ? filteredOrders.map(order => {
              const originalTotal = order.items.reduce((sum,i) => sum + ((i.price||0)*(i.quantity||1)),0);
              const total = order.totalAmount || originalTotal;
              const totalHtml = (order.totalAmount && order.totalAmount !== originalTotal)
                ? `<s>₹${originalTotal}</s> ₹${total}`
                : `₹${total}`;
              return `
                <div class="order">
                  <p><strong>Table:</strong> ${order.table || "-"}</p>
                  <p><strong>Items:</strong> ${order.items.map(i => `${i.name} x ${i.quantity||1}`).join(", ")}</p>
                  <p><strong>Total:</strong> ${totalHtml}</p>
                  <p><strong>Order Code:</strong> ${order.orderCode}</p>
                  <p><strong>Status:</strong> ${order.status}</p>
                  <p><strong>Date:</strong> ${order.date || "-"} <strong>Time:</strong> ${order.time || "-"}</p>
                </div>
              `;
            }).join("")
          : "<p>No orders found.</p>";

        orderCountEl.textContent = `Showing ${filteredOrders.length} order${filteredOrders.length !== 1 ? "s" : ""}`;
        todaySalesEl.textContent = `Today's Sales: ₹${todaySales}`;
        monthSalesEl.textContent = `This Month's Sales: ₹${monthSales}`;
        totalSalesEl.textContent = `Total Sales: ₹${totalSales}`;
      }, err => {
        console.error("Snapshot error:", err);
        ordersDiv.innerHTML = `<p style="color:red;">Error loading orders: ${err.message}</p>`;
      });
    }

    filterSelect.addEventListener("change", () => { highlightStatBox(null); loadOrders(); });
    todaySalesEl.addEventListener("click", () => { filterSelect.value="today"; highlightStatBox(todaySalesEl); loadOrders(); });
    monthSalesEl.addEventListener("click", () => { filterSelect.value="month"; highlightStatBox(monthSalesEl); loadOrders(); });
    totalSalesEl.addEventListener("click", () => { filterSelect.value="all"; highlightStatBox(totalSalesEl); loadOrders(); });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        const currentPage = encodeURIComponent(window.location.pathname);
        await signOut(auth);
        window.location.href = `login.html?redirect=${currentPage}`;
      } catch (err) {
        console.error("Logout error:", err);
        alert("Error logging out. Please try again.");
      }
    });

    loadOrders();
  </script>
</body>
</html>
